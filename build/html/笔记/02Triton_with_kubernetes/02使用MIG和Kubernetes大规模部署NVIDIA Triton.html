<!DOCTYPE html>
<html class="no-js" lang="zh-CN">
<head>
    <meta charset="utf-8" />
        <meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>Kubernetes部署NVIDIA Triton &mdash; SphinxDiary v1.0 文档</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/dist/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
            <link rel="index" title="索引" href="../../genindex.html" />
            <link rel="search" title="搜索" href="../../search.html" />
            <link rel="top" title="SphinxDiary v1.0 文档" href="#" />
            <link rel="up" title="Kubernetes" href="../2-index.html" />
            <link rel="next" title="Kubernetes创建集群" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html" />
            <link rel="prev" title="kubernetes安装" href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html" />
    </head>
<body>
    <script type="text/javascript" src="../../_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="../../index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="../../_static/img/wagtail-logo-new.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        Sphinx Wagtail Theme
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="../../search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">笔记:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1-index.html">Docker</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../01Docker/01Docker%E6%96%B0%E5%BB%BA%E7%94%A8%E6%88%B7.html">Docker新建用户</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01Docker/02Docker%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C.html">Docker基本操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01Docker/03Docker%E5%AE%B9%E5%99%A8%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%81%E7%A7%BB.html">Docker容器备份与迁移</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../2-index.html">Kubernetes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html">kubernetes安装</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kubernetes部署NVIDIA Triton</a></li>
<li class="toctree-l2"><a class="reference internal" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html">Kubernetes创建集群</a></li>
<li class="toctree-l2"><a class="reference internal" href="04Triton%20Metrics.html">Triton Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="05Grafana.html">Grafana</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../3-index.html">Triton</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../03Triton/01Triton_Inference_Server%E5%85%A5%E9%97%A8.html">Triton Inference Server入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03Triton/02Triton%E5%85%A5%E9%97%A8%E7%BA%A7%E6%95%99%E7%A8%8B.html">Triton入门级教程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03Triton/03Triton_Backend%E8%AF%A6%E8%A7%A3.html">Triton_Backend详解</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../4-index.html">Pytorch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../04Pytorch/01%E6%95%B0%E6%8D%AE%E9%9B%86.html">数据集</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../5-index.html">语音识别环境部署教程</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../05%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/01jetpack5.0.2%E5%AE%89%E8%A3%85.html">Jetpack 5.0.2安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/02%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE.html">深度学习环境配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/03%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2.html">语音识别模型部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/04%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86.html">客户端模型推理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B/05%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95.html">性能测试</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../6-index.html">小工具</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/01Git.html">Git</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/2-index.html">Sphinx</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/02Sphinx/01GitHub%20%2B%20Spinx%20%2B%20Read%20the%20docs%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97%EF%BC%88%E4%B8%80%EF%BC%89.html">GitHub + Spinx + Read the docs实战入门指南（一）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/02Sphinx/02GitHub%20%2B%20Spinx%20%2B%20Read%20the%20docs%E5%AE%9E%E6%88%98%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97%EF%BC%88%E4%BA%8C%EF%BC%89.html">GitHub + Spinx + Read the docs实战入门指南（二）</a></li>
<li class="toctree-l3"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/02Sphinx/03Markdown.html">Markdown</a></li>
<li class="toctree-l3"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/02Sphinx/04MyST-Parser.html">MyST-Parser</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/03Fastertransformer.html">Fastertransformer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/04FileBrowser.html">FileBrowser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/05NFS%E9%85%8D%E7%BD%AE.html">NFS配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/06%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7.html">服务器文件管理工具</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06%E5%B0%8F%E5%B7%A5%E5%85%B7/07StableDiffusion.html">Stable Diffusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../7-index.html">NNI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../07NNI/01-NNI%E7%A4%BA%E4%BE%8B.html">NNI 示例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07NNI/02-NNI%E9%83%A8%E7%BD%B2.html">NNI 部署</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../8-index.html">Android</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../08Android/01Android%20APK.html">Android APK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../9-index.html">Android Studio</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../09Android%20Studio/01Android%E4%BD%BF%E7%94%A8.html">1.导入.aar文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09Android%20Studio/01Android%E4%BD%BF%E7%94%A8.html#app-build-gradle-dependencies">2.在app/build.gradle dependencies中加入：</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09Android%20Studio/01Android%E4%BD%BF%E7%94%A8.html#id1">3.重新编译工程</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">论文:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/1-index.html">Fine tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/01Fine_tuning/01Prompt%20Tuning.html">Prompt Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/01Fine_tuning/02Prompt%20Tuning%20v2.html">Prompt Tuning V2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/01Fine_tuning/03Lora.html">LoRA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/01Fine_tuning/04ChatGLM%E5%BE%AE%E8%B0%83%E5%AE%9E%E9%AA%8C.html">ChatGLM微调实验</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/2-index.html">语音识别</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/1-index.html">语音识别综述</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/01%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%BB%BC%E8%BF%B0/1-Recent%20Advance%20in%20End-to-End%20Automatic%20Speech%20Recognition.html">1-Recent Advance in End-to-End Automatic Speech Recognition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/01%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB%E7%BB%BC%E8%BF%B0/2-A%20Comparative%20Study%20On%20Transformer%20VS%20RNN%20In%20Speech%20Applications.html">2-A Comparative Study On Transformer VS RNN In Speech Applications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/2-index.html">Wenet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/1-WeNet%20Production%20Oriented%20Streaming%20and%20Non-Streaming%20End-to-End%20Speech%20Recognition%20Toolkit.html">1-WeNet Production Oriented Streaming and Non-Streaming End-to-End Speech Recognition Toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/2-WeNet2.0%20More%20Productive%20End-to-End%20Speech%20Recognition%20Toolkit.html">2-Wenet2.0 More Productive End-to-End Speech Recognition Toolkit</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/3-WeNet-LM%E6%A8%A1%E5%9E%8B.html">3-WeNet-LM模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/4-WeNet%E6%A8%A1%E5%9E%8B%E7%BB%93%E6%9E%84.html">4-Wenet模型结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/5-WeNet%E5%AE%9E%E9%AA%8C%E5%B0%8F%E7%BB%93.html">5-WeNet实验小结</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/02Wenet/6-WeNet%E9%83%A8%E7%BD%B2.html">6-WeNet部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/3-index.html">模型微调</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/03%E6%A8%A1%E5%9E%8B%E5%BE%AE%E8%B0%83/1-FINE-TUNING%20OF%20PRE-TRAINED%20END-TO-END%20SPEECH%20RECOGNITION%20WITH%20GENERATIVE%20ADVERSARIAL%20NETWORKS.html">1-Fine-Tuning Of Pre-trained end-to-end Speech Recognition With Generative Adversarial Networks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/4-index.html">编码器</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/04%E7%BC%96%E7%A0%81%E5%99%A8/1-Conformer-Convolution-augmented%20Transformer%20for%20Speech%20Recognition.html">1-Conformer-Convolution-augmented Transformer for Speech Recognition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/04%E7%BC%96%E7%A0%81%E5%99%A8/2-Paraformer-Fast%20and%20Accurate%20Parallel%20Transformer%20for%20Non-autoregressive.html">2-Paraformer-Fast and Accurate Parallel Transformer for Non-autoregressive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/04%E7%BC%96%E7%A0%81%E5%99%A8/3-LFEformer-Local_Feature_Enhancement_Using_Sliding_Window_With_Deformability_for_Automatic_Speech_Recognition.html">3-LFEformer-Local Feature Enhancement Using Sliding Window With Deformability for Automatic Speech Recognition</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/02%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/04%E7%BC%96%E7%A0%81%E5%99%A8/4-Squeezeformer-An%20Efficient%20Transformer%20for%20Automatic%20Speech%20Recognition.html">4-Squeezeformer-An Efficient Transformer for Automatic Speech Recognition</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/3-index.html">联邦学习</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/03%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0/1-index.html">联邦学习项目</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/03%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0/01%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E9%A1%B9%E7%9B%AE/1-%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE.html">联邦学习开源项目</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/4-index.html">语言模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../%E8%AE%BA%E6%96%87/04%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/1-Transformer-XL-Attention%20Language%20Models%20Beyond%20a%20Fixed-Length%20Context.html">1-Transformer-XL-Attention Language Models Beyond a Fixed-Length Context</a></li>
</ul>
</li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="../../index.html">Docs</a></li>
            <li class="breadcrumb-item"><a href="../2-index.html">Kubernetes</a></li>
        <li class="breadcrumb-item active" aria-current="page">Kubernetes部署NVIDIA Triton</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/笔记/02Triton_with_kubernetes/02使用MIG和Kubernetes大规模部署NVIDIA Triton.md" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="../../_sources/笔记/02Triton_with_kubernetes/02使用MIG和Kubernetes大规模部署NVIDIA Triton.md.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section class="tex2jax_ignore mathjax_ignore" id="kubernetesnvidia-triton">
<h1>Kubernetes部署NVIDIA Triton<a class="headerlink" href="#kubernetesnvidia-triton" title="此标题的永久链接">¶</a></h1>
<p>​	docker版本：20.10.21</p>
<p>​	k8s版本：1.21.3</p>
<p>​	多实例GPU(multi-instance GPU, MIG)可以通过并行运行多个工作负载，最大限度提高RTX 3090 Ti GPU利用率，MIG功能可以将单个GPU划分为多个称为GPU实例的GPU分区，每个分区有专用的内存和计算资源，因此硬件级隔离可确保同时运行工作负载，同时保证服务质量和故障隔离。</p>
<ul class="simple">
<li><p>在RTX 3090 Ti上使用MIG并行部署多个Triton推理服务器</p></li>
<li><p>使用Kubernetes和Prometheus监控堆栈，根据推理请求的数量自动扩展Triton推理服务器的数量</p></li>
<li><p>使用NGINX PLUS负载均衡器在不同的Triton推理服务器之间平均分配推理负载</p></li>
</ul>
<p>扩展到Kubernetest环境中部署，可以根据推理请求自动调整Triton推理服务器的数量，并且推理负载能够分布在所有服务器之间，实现负载均衡。</p>
<section id="kubernetes-deployment">
<h2>1、创建Kubernetes Deployment<a class="headerlink" href="#kubernetes-deployment" title="此标题的永久链接">¶</a></h2>
<p>​	第一步是为Triton推理服务器创建Kubernetes部署。部署为Pods和ReplicaSet提供声明性更新。Kubernetes中的ReplicaSet同时启动同一Pod的多个实例。</p>
<p>​	以下文件创建了三个replicated Pods，每个Pod运行一个名为speech的容器，该容器运行wenet_server:22.03版本Triton推理服务器镜像，与NVIDIA Triton端口号相同，容器端口8000、8001、8002分别为HTTP、gRPC和NVIDIA Triton metrics</p>
<p>​	使用混合策略为一个5G MIG设备分配给每个Pod。如果没有共享文件系统，则必须确保将模型加载到所有工作节点，以便Kubernetes启动的Pods可以访问</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">dshm</span>
        <span class="n">emptyDir</span><span class="p">:</span>
          <span class="n">medium</span><span class="p">:</span> <span class="n">Memory</span>
          <span class="n">sizeLimit</span><span class="p">:</span> <span class="mi">2048</span><span class="n">Mi</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
          <span class="n">ports</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8000</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">http</span><span class="o">-</span><span class="n">triton</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8001</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span><span class="o">-</span><span class="n">triton</span>
          <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8002</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">triton</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">wenet_server</span><span class="p">:</span><span class="mf">22.03</span>
          <span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">]</span>
          <span class="n">args</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bash /workspace/infer.sh&quot;</span><span class="p">]</span>
          <span class="n">volumeMounts</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span>
              <span class="n">name</span><span class="p">:</span> <span class="n">dshm</span>
</pre></div>
</div>
<p>​	使用kuberctl apply创建Kubernetes部署</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">speech</span><span class="o">-</span><span class="n">replicas2</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>显示</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deployment</span><span class="o">.</span><span class="n">apps</span><span class="o">/</span><span class="n">speech</span> <span class="n">created</span>
</pre></div>
</div>
<p><strong>出现问题</strong></p>
<p>查看pods，发现状态为Pending</p>
<p><img alt="" src="../../_images/image-20230320112006623.png" /></p>
<p>查看具体原因执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">speech</span><span class="o">-</span><span class="mi">677</span><span class="n">b4999cf</span><span class="o">-</span><span class="mi">9</span><span class="n">nsrq</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230320111921236.png" /></p>
<p><strong>解决方案1</strong></p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_43114954/article/details/119153903">(70条消息) 0/1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn‘t_YuanOo。的博客-CSDN博客</a></p>
<p>原因：当创建单机版的 k8s 时，这个时候 master 节点是默认不允许调度 pod</p>
<p>解决方案：将master标记为可调度即可</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="nb">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
</pre></div>
</div>
<p><strong>删除Deployment命令</strong></p>
<p>​	若要重新apply YAML文件，需要删除之间部署的speech</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">deployment</span> <span class="n">speech</span>
</pre></div>
</div>
</section>
<section id="kubernetes-service">
<h2>2、创建Kubernetes Service<a class="headerlink" href="#kubernetes-service" title="此标题的永久链接">¶</a></h2>
<p>​	第二步是创建一个Kubernetes服务，将Triton推理服务器作为网络服务公开。创建服务时，使用Type字段选择自动创建外部负载均衡选项，其提供了一个外部可访问的IP地址，用于将流量发送到节点上的正确端口：</p>
<p>speech-service.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8000</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8000</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8001</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8001</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8002</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8002</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">LoadBalancer</span> 
</pre></div>
</div>
<p>​	使用如下命令创建Kubernetes服务</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">speech</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230321113735206.png" /></p>
<p>​	验证服务创建成功</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">svc</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230321113857175.png" /></p>
<p>现在，Triton推理服务器已准备好接收来自远程客户端的推理请求，如果客户端发送推理请求，则客户端可以查看语音识别的结果。10.24.83.40: 30869</p>
<p><img alt="" src="../../_images/image-20230321122629260.png" /></p>
<p>至此，多个Triton推理服务器在Kubernetes环境中运行，对客户端发送的语音进行推理，可以手动更改服务器的数量。在接下来的部分中，对其进行改进，以便可以根据客户端请求自动调整服务器的数量。</p>
</section>
<section id="prometheus">
<h2>3、安装Prometheus<a class="headerlink" href="#prometheus" title="此标题的永久链接">¶</a></h2>
<p>​	Prometheus是K8s集群内应用广泛的监控服务，要自动更改Kubernetest Pods上Trition推理服务器的数量，首先收集用于自定义度量NVIDIA Triton性能，因为有来自多个Kubernetes Pods下的NVIDIA Triton指标，所以需要部署一个PodMonitor，告诉Prometheus从所有的Pods中收集指标。</p>
<p>​	Prometheus是一款开源的系统监控和报警工具包，提供由度量名称键值对标识的时间序列数据。PromQL是一种灵活的查询语言，用于查询Prometheus的度量。</p>
<section id="id1">
<h3>3.1 安装Prometheus<a class="headerlink" href="#id1" title="此标题的永久链接">¶</a></h3>
<p>下载地址：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">operator</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">refs</span><span class="o">/</span><span class="n">tags</span><span class="o">/</span><span class="n">v0</span><span class="mf">.9.0</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>解压后，执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span><span class="n">setup</span>
<span class="n">until</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">servicemonitors</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">namespaces</span> <span class="p">;</span> <span class="n">do</span> <span class="n">date</span><span class="p">;</span> <span class="n">sleep</span> <span class="mi">1</span><span class="p">;</span> <span class="n">echo</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="n">done</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span>
</pre></div>
</div>
<p>删除指令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="ow">not</span><span class="o">-</span><span class="n">found</span><span class="o">=</span><span class="n">true</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span> <span class="o">-</span><span class="n">f</span> <span class="n">manifests</span><span class="o">/</span><span class="n">setup</span>
</pre></div>
</div>
<p>验证：</p>
<p><img alt="" src="../../_images/image-20230321154509028.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">monitoring</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="n">svc</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">k8s</span> <span class="mi">9090</span>
</pre></div>
</div>
<p><strong>两个镜像</strong></p>
<p>1、kube-state-metrics</p>
<p>位于manifests/kube-state-metrics-deployment.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chenby</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">state</span><span class="o">-</span><span class="n">metrics</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>
</pre></div>
</div>
<p>2、prometheus-adapter</p>
<p>位于manifests/prometheus-adapter-deployment.yaml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">chenby</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="p">:</span><span class="n">v0</span><span class="mf">.9.0</span>
</pre></div>
</div>
<p><strong>暴露prometheus和grafana端口</strong></p>
<p>目录：manifests/prometheus-service.yaml，端口映射到32101</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">version</span><span class="p">:</span> <span class="mf">2.29.1</span>
    <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span><span class="o">-</span><span class="n">k8s</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">web</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">9090</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">web</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="mi">32101</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
  <span class="n">sessionAffinity</span><span class="p">:</span> <span class="n">ClientIP</span>
</pre></div>
</div>
<p>目录：manifests/grafana-service.yaml，端口映射到32102</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">version</span><span class="p">:</span> <span class="mf">8.1.1</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">3000</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="n">http</span>
    <span class="n">nodePort</span><span class="p">:</span> <span class="mi">32102</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">component</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="p">:</span> <span class="n">grafana</span>
    <span class="n">app</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>3.2 修改Prometheus配置文件<a class="headerlink" href="#id2" title="此标题的永久链接">¶</a></h3>
<p>为了使Prometheus监控服务全部部署在主节点上，需要指定服务的部署节点，需要修改以下文件</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>服务类型</p></th>
<th class="head"><p>服务名称</p></th>
<th class="head"><p>服务文件</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Prometheus Server</p></td>
<td><p>prometheus</p></td>
<td><p>prometheis-prometheus.yaml</p></td>
</tr>
<tr class="row-odd"><td><p>Setup</p></td>
<td><p>setup</p></td>
<td><p>prometheus-operator-deployment.yaml</p></td>
</tr>
<tr class="row-even"><td><p>Prom-adapter</p></td>
<td><p>adapter</p></td>
<td><p>prometheus-adapter-deployment.yaml</p></td>
</tr>
<tr class="row-odd"><td><p>metrics-state</p></td>
<td><p>kube-state-metrics</p></td>
<td><p>kube-state-metrics-deployment.yaml</p></td>
</tr>
<tr class="row-even"><td><p>blackbos</p></td>
<td><p>blackbox</p></td>
<td><p>blackbox-exporter-deployment.yaml</p></td>
</tr>
</tbody>
</table>
<p>有两种修改方式：</p>
<ul class="simple">
<li><p>通过节点类型指定，这样可以批量指定</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nodeSelector</span><span class="p">:</span>
	<span class="nb">type</span><span class="p">:</span> <span class="n">cloud_1080_ti</span>
</pre></div>
</div>
<p>不同节点的type可以使用<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">label</span></code>进行指定</p>
<ul class="simple">
<li><p>通过节点名称指定，这样可以更精确指定</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nodeName</span><span class="p">:</span>
	<span class="n">master</span>
</pre></div>
</div>
</section>
</section>
<section id="id3">
<h2>4、缩扩容服务<a class="headerlink" href="#id3" title="此标题的永久链接">¶</a></h2>
<p>​	Prometheus在监视服务器，接下来部署Prometheus适配器，它知道如何与Kubernetes和Prometheus通信，适配器能够使用Prometheus收集的指标作出缩放决策。</p>
<section id="podmonitor">
<h3>4.1 创建PodMonitor<a class="headerlink" href="#podmonitor" title="此标题的永久链接">¶</a></h3>
<p>​	在<code class="docutils literal notranslate"><span class="pre">speech-pod-monitor.yml</span></code>文件中，定义一个PodMonitor来监视服务器的pod，如spec.selector字段所示，还需要kube-prometheus，包括prometheus的部署，并抓取链接到Prometheus各种度量端点的目标配置，如spec.podMetricsEndpoints字段所示，Prometheus每隔10s从这些端点抓取NVIDIA Triton指标：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">monitoring</span><span class="o">.</span><span class="n">coreos</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PodMonitor</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="n">tritonmetrics</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
  <span class="n">labels</span><span class="p">:</span>
      <span class="n">prometheus</span><span class="p">:</span> <span class="n">k8s</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">selector</span><span class="p">:</span>
      <span class="n">matchLabels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
   <span class="n">namespaceSelector</span><span class="p">:</span>
      <span class="n">matchNames</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">default</span>
   <span class="n">podMetricsEndpoints</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">triton</span>
     <span class="n">interval</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
     <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">metrics</span>
</pre></div>
</div>
<p>要匹配NVIDIA Triton Deployment的标签，确保<code class="docutils literal notranslate"><span class="pre">spec.selector.matchLabels</span></code>字段为<code class="docutils literal notranslate"><span class="pre">app:</span> <span class="pre">speech</span></code>，<code class="docutils literal notranslate"><span class="pre">spec.namespaceSelector.matchNames</span></code>字段为<code class="docutils literal notranslate"><span class="pre">-default</span></code>，两者都应与NVIDIA Triton Deployment位于同一命名空间下。</p>
<p>使用命令<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">speech-pod-monitor.yml</span></code>并验证</p>
<p><img alt="" src="../../_images/image-20230321154541639.png" /></p>
<p>​	默认情况下，Prometheus附带了一个用户界面，可以在Prometheus服务器9090号端口访问，地址是http://10.24.83.40:30503/，在输入框中输入以下命令可以爬取Triton输出的指标</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">avg</span><span class="p">(</span><span class="n">delta</span><span class="p">(</span><span class="n">nv_inference_queue_duration_us</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">delta</span><span class="p">(</span><span class="n">nv_inference_request_success</span><span class="p">[</span><span class="mi">30</span><span class="n">s</span><span class="p">])))</span>
</pre></div>
</div>
</section>
<section id="configmap">
<h3>4.2 创建ConfigMap<a class="headerlink" href="#configmap" title="此标题的永久链接">¶</a></h3>
<p>​	首先需要告诉Prometheus如何收集特定的度量，在ConfigMap中自定义平均等待时间<code class="docutils literal notranslate"><span class="pre">avg_time_queue_us</span></code>度量，<code class="docutils literal notranslate"><span class="pre">nv_inference_request_success[30]</span></code>定义了过去30s成功推理请求数目，<code class="docutils literal notranslate"><span class="pre">nv_inference_quene_duration_us</span></code>定义了以微秒为单位的累计排队持续时间。</p>
<p>​	自定义度量指过去30s每个推理请求的平均队列时间，HPA根据该时间决定是否改变replicas数目。</p>
<p>​	度量需要有一个endpoint，未编址的度量无法从度量API查询，添加<code class="docutils literal notranslate"><span class="pre">.overrides</span></code>字段，强制pod和namespaces之后在API中分开</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">adapter</span><span class="o">-</span><span class="n">config</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">triton</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">rules</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">seriesQuery</span><span class="p">:</span> <span class="s1">&#39;nv_inference_queue_duration_us{namespace=&quot;default&quot;,pod!=&quot;&quot;}&#39;</span>
      <span class="n">resources</span><span class="p">:</span>
        <span class="n">overrides</span><span class="p">:</span>
          <span class="n">namespace</span><span class="p">:</span>
            <span class="n">resource</span><span class="p">:</span> <span class="s2">&quot;namespace&quot;</span>
          <span class="n">pod</span><span class="p">:</span>
            <span class="n">resource</span><span class="p">:</span> <span class="s2">&quot;pod&quot;</span>
      <span class="n">name</span><span class="p">:</span>
        <span class="n">matches</span><span class="p">:</span> <span class="s2">&quot;nv_inference_queue_duration_us&quot;</span>
        <span class="k">as</span><span class="p">:</span> <span class="s2">&quot;avg_time_queue_us&quot;</span>
      <span class="n">metricsQuery</span><span class="p">:</span> <span class="s1">&#39;avg(delta(nv_inference_queue_duration_us[30s])/(1+delta(nv_inference_request_success[30s]))) by (&lt;&lt;.GroupBy&gt;&gt;)&#39;</span>
</pre></div>
</div>
<p>执行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>出现</p>
<p><img alt="" src="../../_images/image-20230321204503467.png" /></p>
</section>
<section id="prometheus-adapter">
<h3>4.3 创建Prometheus Adapter<a class="headerlink" href="#prometheus-adapter" title="此标题的永久链接">¶</a></h3>
<p>​	首先：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">clusterrolebinding</span> <span class="n">permissive</span><span class="o">-</span><span class="n">binding</span> <span class="o">--</span><span class="n">clusterrole</span><span class="o">=</span><span class="n">cluster</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">admin</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">kubelet</span> <span class="o">--</span><span class="n">group</span><span class="o">=</span><span class="n">system</span><span class="p">:</span><span class="n">serviceaccounts</span> 
</pre></div>
</div>
<p>​	为了使HPA对这个自定义度量做出反应，必须为Prometheus Adapter创建Deployment、Service、APIService，以下是部署文件custom-metrics-server-Deployment.yml。其使用ConfigMap告诉适配器收集自定义度量，创建Deployment，adapter Pod提取自定义度量。containers.config字段必须与.mountPath字段和上一步在ConfigMap中创建的文件名triton-adapter-config.yml匹配。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metris</span><span class="o">-</span><span class="n">apiserver</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">coreos</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">prometheus</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">amd64</span><span class="p">:</span><span class="n">v0</span><span class="mf">.8.0</span>
        <span class="n">args</span><span class="p">:</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">cert</span><span class="o">-</span><span class="nb">dir</span><span class="o">=/</span><span class="n">tmp</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">prometheus</span><span class="o">-</span><span class="n">url</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">10.24.83.40</span><span class="p">:</span><span class="mi">30503</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">metrics</span><span class="o">-</span><span class="n">relist</span><span class="o">-</span><span class="n">interval</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">v</span><span class="o">=</span><span class="mi">10</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">config</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">triton</span><span class="o">-</span><span class="n">adapter</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">yml</span>
        <span class="o">-</span> <span class="o">--</span><span class="n">secure</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">6443</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">main</span><span class="o">-</span><span class="n">port</span>
          <span class="n">containerPort</span><span class="p">:</span> <span class="mi">6443</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span><span class="o">-</span><span class="n">volume</span>
          <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">config</span>
          <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span><span class="o">-</span><span class="n">volume</span>
        <span class="n">configMap</span><span class="p">:</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">adapter</span><span class="o">-</span><span class="n">config</span>
</pre></div>
</div>
<p><img alt="image-20230322203935105" src="../../_images/image-20230322203935105.png" /></p>
<p>接下来创建<code class="docutils literal notranslate"><span class="pre">custom-metrics-server-service.yml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">api</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">6443</span> 
</pre></div>
</div>
<p>接下来，创建一个APIService，以便Kubernetes可以访问Prometheus adapter。以下是文件<code class="docutils literal notranslate"><span class="pre">custom-metrics-server-apiservice.yml</span></code>，.spec.service字段必须与Service文件的.metadata字段匹配，为了允许自动缩放器访问自定义度量，需要向API aggregator注册该metrics，<a class="reference external" href="http://xn--APIcustom-9c9nt01rctwbjydl97fyk1b.metrics.k8s.io/v1beta1">需要使用的API是custom.metrics.k8s.io/v1beta1</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apiregistration</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">APIService</span>
<span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">v1beta1</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">insecureSkipTLSVerify</span><span class="p">:</span> <span class="n">true</span>
   <span class="n">group</span><span class="p">:</span> <span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
   <span class="n">groupPriorityMinimum</span><span class="p">:</span> <span class="mi">100</span>
   <span class="n">versionPriority</span><span class="p">:</span> <span class="mi">5</span>
   <span class="n">service</span><span class="p">:</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">triton</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">api</span>
     <span class="n">namespace</span><span class="p">:</span> <span class="n">monitoring</span>
   <span class="n">version</span><span class="p">:</span> <span class="n">v1beta1</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3>4.4 查询创建的自定义指标<a class="headerlink" href="#id4" title="此标题的永久链接">¶</a></h3>
<p>​	使用命令kubectl apply来应用三个前面提到的.yml文件配置，为Prometheus创建API Service之后，可以看到custom metrics可用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230327192343568.png" /></p>
<p>还可以检查custom metrics的当前值，该值为0表示没有来自客户端的推理请求，default namespace选择所有pod，其中部署了speech-demo：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="o">--</span><span class="n">raw</span> <span class="o">/</span><span class="n">apis</span><span class="o">/</span><span class="n">custom</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1beta1</span><span class="o">/</span><span class="n">namespaces</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">pods</span><span class="o">/*/</span><span class="n">avg_time_queue_us</span> <span class="o">|</span> <span class="n">jq</span> <span class="o">.</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230327192704313.png" /></p>
</section>
</section>
<section id="hpa">
<h2>5、部署HPA<a class="headerlink" href="#hpa" title="此标题的永久链接">¶</a></h2>
<p>​	现在可以创建一个用于自定义度量的HPA，HPA可以根据观察到的指标自动缩放复制器中Pods的数量。HPA根据监测值和当前值的比率来控制Kubernetes中replicas Pods的数量。
$<span class="math notranslate nohighlight">\(
R = ceil(CR \cdot \frac{CV}{DV})
\)</span><span class="math notranslate nohighlight">\(
\)</span>R<span class="math notranslate nohighlight">\(表示Kubernetes拥有replicas的数量；\)</span>CR<span class="math notranslate nohighlight">\(是当前replicas pod的数量；\)</span>CV<span class="math notranslate nohighlight">\(是当前的metrics，表示来自所有servers的自定义度量的平均值；\)</span>DV<span class="math notranslate nohighlight">\(是所需的度量值。当\)</span>R<span class="math notranslate nohighlight">\(与\)</span>CR$不同时，HPA可以增加或减少replicas的数量。</p>
<p>​	以下HPA文件<code class="docutils literal notranslate"><span class="pre">speech-HPA.yml</span></code>可以自动缩放Triton推理服务器的部署，使用<code class="docutils literal notranslate"><span class="pre">.spec.targetAverageValue</span></code>字段所需的度量值。该字段定期调整pods的数量，以使观察到的自定义度量与目标值匹配。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">autoscaling</span><span class="o">/</span><span class="n">v2beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">HorizontalPodAutoscaler</span>
<span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">speech</span><span class="o">-</span><span class="n">hpa</span>
<span class="n">spec</span><span class="p">:</span>
   <span class="n">scaleTargetRef</span><span class="p">:</span>
     <span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta1</span>
     <span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">speech</span>
   <span class="n">minReplicas</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">maxReplicas</span><span class="p">:</span> <span class="mi">3</span>
   <span class="n">metrics</span><span class="p">:</span>
   <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Pods</span>
     <span class="n">pods</span><span class="p">:</span>
       <span class="n">metricName</span><span class="p">:</span> <span class="n">avg_time_queue_us</span>
       <span class="n">targetAverageValue</span><span class="p">:</span> <span class="mi">10000</span>
</pre></div>
</div>
<p>可以查看部署的HPA状态：</p>
<p><img alt="" src="../../_images/image-20230327200937175.png" /></p>
<p>如果客户端向服务器发送推理请求，则新的HPA可以获取部署的自定义度量，并建立所需Pod的数量，当客户端停止发送推理请求时，HPA将replicas数量减少到只有1。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">hpa</span>

<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">hpa</span> <span class="n">speech</span><span class="o">-</span><span class="n">hpa</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230327203412462.png" /></p>
</section>
<section id="nginx-plus">
<h2>6、使用NGINX Plus负载均衡<a class="headerlink" href="#nginx-plus" title="此标题的永久链接">¶</a></h2>
<p>​	负载均衡是为了在可用的服务器之间以最佳方式分配来自客户端的负载。NGINX Plus作为高级7层负载均衡</p>
<p>​	在该demo中，使用Prometheus，通过autoscaler新添加的Pods无法使用Kubernetes内置的负载均衡器获得工作负载。使用NGINX Plus，它是第七层（应用层）负载均衡器，工作负载均匀分布在所有Pods中，包括新扩展的Pod。</p>
<p>​	首先需要创建一个NGINX镜像，因为Dockerhub无法提供NGINX Plus商业产品。使用Docker Hub中的NGINX开源镜像在Docker容器中创建一个NGINX实例，然后将本地镜像推送到一个专用的Docker注册表中。</p>
<p>​	接下来，要部署NGINX Plus，使用以下命令将要部署NGINX Plus的节点标记为<code class="docutils literal notranslate"><span class="pre">role=nginxplus</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">label</span> <span class="n">node</span> <span class="n">xmdx</span> <span class="n">role</span><span class="o">=</span><span class="n">nginxplus</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/image-20230403111341595.png" /></p>
<p>​	修改Service将Cluster IP设置为None，暴露并标识所有的replicas端点。创建一个新的Service文件<code class="docutils literal notranslate"><span class="pre">speech-service-nginx.yml</span></code>，并且apply it：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
<span class="n">Spec</span><span class="p">:</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="kc">None</span> 
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">speech</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8000</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8000</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8001</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8001</span> 
</pre></div>
</div>
<p>​	现在，为NGINX创建一个配置文件，位于<code class="docutils literal notranslate"><span class="pre">/path/to/nginx/config/nginx.conf</span></code>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resolver</span> <span class="mf">10.96.0.10</span> <span class="n">valid</span><span class="o">=</span><span class="mi">5</span><span class="n">s</span><span class="p">;</span>
<span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
   <span class="n">zone</span> <span class="n">upstream</span><span class="o">-</span><span class="n">backend</span> <span class="mi">64</span><span class="n">k</span><span class="p">;</span>
   <span class="n">server</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8000</span> <span class="n">resolve</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">upstream</span> <span class="n">backendgrpc</span> <span class="p">{</span>
   <span class="n">zone</span> <span class="n">upstream</span><span class="o">-</span><span class="n">backend</span> <span class="mi">64</span><span class="n">k</span><span class="p">;</span>
   <span class="n">server</span> <span class="n">speech</span><span class="o">-</span><span class="n">nginx</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8001</span> <span class="n">resolve</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
   <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
   <span class="n">status_zone</span> <span class="n">backend</span><span class="o">-</span><span class="n">servers</span><span class="p">;</span>
  
   <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
     <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">backend</span><span class="p">;</span>
     <span class="n">health_check</span> <span class="n">uri</span><span class="o">=/</span><span class="n">v2</span><span class="o">/</span><span class="n">health</span><span class="o">/</span><span class="n">ready</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">89</span> <span class="n">http2</span><span class="p">;</span>
 
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
            <span class="n">grpc_pass</span> <span class="n">grpc</span><span class="p">:</span><span class="o">//</span><span class="n">backendgrpc</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
  
<span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">8080</span><span class="p">;</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="p">;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">dashboard</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="p">}</span>
    <span class="n">location</span> <span class="o">=</span> <span class="o">/</span> <span class="p">{</span>
       <span class="k">return</span> <span class="mi">302</span> <span class="o">/</span><span class="n">dashboard</span><span class="o">.</span><span class="n">html</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">location</span> <span class="o">/</span><span class="n">api</span> <span class="p">{</span>
      <span class="n">api</span> <span class="n">write</span><span class="o">=</span><span class="n">on</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> 
</pre></div>
</div>
<p>​	最后，在<code class="docutils literal notranslate"><span class="pre">nginxplus-rc.yml</span></code>文件中，为NGINX Plus创建一个ReplicationController。要从私有注册表中提取镜像，Kubernetes需要凭据(credentials)。配置文件中的<code class="docutils literal notranslate"><span class="pre">imagePullSecrets</span></code>字段指定Kubernetes应该从名为regcred的Secret中获取凭据。在这个配置文件中，还必须将上一步创建的NGINX配置文件挂载到<code class="docutils literal notranslate"><span class="pre">/etc/nginx/conf.d</span></code>下。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
 <span class="n">kind</span><span class="p">:</span> <span class="n">ReplicationController</span>
 <span class="n">metadata</span><span class="p">:</span>
   <span class="n">name</span><span class="p">:</span> <span class="n">nginxplus</span><span class="o">-</span><span class="n">rc</span>
 <span class="n">spec</span><span class="p">:</span>
   <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
   <span class="n">selector</span><span class="p">:</span>
     <span class="n">app</span><span class="p">:</span> <span class="n">nginxplus</span>
   <span class="n">template</span><span class="p">:</span>
     <span class="n">metadata</span><span class="p">:</span>
       <span class="n">labels</span><span class="p">:</span>
         <span class="n">app</span><span class="p">:</span> <span class="n">nginxplus</span>
     <span class="n">spec</span><span class="p">:</span>
       <span class="n">nodeSelector</span><span class="p">:</span>
         <span class="n">role</span><span class="p">:</span> <span class="n">nginxplus</span>
       <span class="n">imagePullSecrets</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">regcred</span>
       <span class="n">containers</span><span class="p">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nginxplus</span>
         <span class="n">command</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span> <span class="p">]</span>
         <span class="n">args</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;nginx; while true; do sleep 30; done;&quot;</span> <span class="p">]</span>
         <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
         <span class="n">image</span><span class="p">:</span> <span class="n">nvcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">nvidian</span><span class="o">/</span><span class="n">swdl</span><span class="o">/</span><span class="n">nginxplus</span><span class="p">:</span><span class="n">v1</span>
         <span class="n">ports</span><span class="p">:</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">80</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8085</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">grpc</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">89</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8087</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span><span class="o">-</span><span class="n">alt</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8080</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">8086</span>
           <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">flower</span><span class="o">-</span><span class="n">svc</span>
             <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8000</span>
             <span class="n">hostPort</span><span class="p">:</span> <span class="mi">32309</span>
         <span class="n">volumeMounts</span><span class="p">:</span>
           <span class="o">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/etc/nginx/conf.d&quot;</span>
             <span class="n">name</span><span class="p">:</span> <span class="n">etc</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">confd</span>
       <span class="n">volumes</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">nfs</span><span class="p">:</span>
            <span class="n">server</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">NFS</span> <span class="n">server</span> <span class="n">IP</span><span class="o">&gt;</span>
            <span class="n">path</span><span class="p">:</span> <span class="o">&lt;/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">config</span><span class="o">&gt;</span>
            <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
           <span class="n">name</span><span class="p">:</span> <span class="n">etc</span><span class="o">-</span><span class="n">nginx</span><span class="o">-</span><span class="n">confd</span> 
</pre></div>
</div>
<p>​	使用以下命令创建ReplicationController：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginxplus</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">yml</span>  
</pre></div>
</div>
<p>验证Deployment，可以看到NGINX Plus正在运行</p>
<p>现在，当客户端向服务器发送推理请求时，可以看到NGINX Plus Dashboard：</p>
<ul class="simple">
<li><p>自动缩放器的数量从一个逐渐增加到七个</p></li>
<li><p>工作负载在所有Pod之间均匀分布，如Traffic中所示</p></li>
</ul>
<p>还可以通过检查Prometheus中所有Pods的度量值或自定义度量值来确认新添加的Pods处于工作状态</p>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="01%E5%9C%A8Ubuntu18.04%E4%B8%8A%E6%90%AD%E5%BB%BAkubernetes.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span>kubernetes安装
    </a>
    <a class="float-right" href="03%E4%BD%BF%E7%94%A8Kubernetes%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.html" title="Next">
        Kubernetes创建集群 <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">Kubernetes部署NVIDIA Triton</a><ul>
<li><a class="reference internal" href="#kubernetes-deployment">1、创建Kubernetes Deployment</a></li>
<li><a class="reference internal" href="#kubernetes-service">2、创建Kubernetes Service</a></li>
<li><a class="reference internal" href="#prometheus">3、安装Prometheus</a><ul>
<li><a class="reference internal" href="#id1">3.1 安装Prometheus</a></li>
<li><a class="reference internal" href="#id2">3.2 修改Prometheus配置文件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">4、缩扩容服务</a><ul>
<li><a class="reference internal" href="#podmonitor">4.1 创建PodMonitor</a></li>
<li><a class="reference internal" href="#configmap">4.2 创建ConfigMap</a></li>
<li><a class="reference internal" href="#prometheus-adapter">4.3 创建Prometheus Adapter</a></li>
<li><a class="reference internal" href="#id4">4.4 查询创建的自定义指标</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hpa">5、部署HPA</a></li>
<li><a class="reference internal" href="#nginx-plus">6、使用NGINX Plus负载均衡</a></li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                <p style="display: none">
                    <a class="text-light" href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Wagtail Sphinx Theme 6.0.0
                    </a>
                </p>
            </div>
            <div class="text-center">
                    &copy; Copyright 2023, 李仲亮
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/translations.js"></script>
        <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script type="text/javascript" src="../../_static/dist/theme.js"></script>
        <script type="text/javascript" src="../../_static/dist/vendor.js"></script>
        <script type="text/javascript" src="../../_static/searchtools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("../../searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>